<div class="b-search">
	<div class="b-search_form">
		<form class="b-search_form_set" action="">
			<span class="b-formfield b-popup_content_form_from">
				<span class="b-formfield_select">
					<select name="cityId">
					  <%City.all.each do |c|%>
		                <option value="<%=c.id%>" <%=c.id == params[:cityId].to_i ? 'selected="selected"'.html_safe : ''%>><%=c.name%></option>
		              <%end%>
					</select>
					<span class="b-formfield_select_content"></span>
					<span class="b-formfield_select_icon"><i></i></span>
				</span>
			</span>
			<i class="b-popup_content_form_direction"></i>
			<span class="b-formfield b-popup_content_form_to">
				<span class="b-formfield_select">
					<select name="countryId">
					  <%Country.all.each do |c|%>
		                <option value="<%=c.id%>" <%=c.id.to_i == params[:countryId].to_i ? 'selected="selected"' : ''%>><%=c.name%></option>
		              <%end%>
					</select>
					<span class="b-formfield_select_content"></span>
					<span class="b-formfield_select_icon"><i></i></span>
				</span>
			</span>
			
			<label>вылет <span class="b-formfield b-popup_content_form_date_field"><input class="b-popup_content_form_date js-field_count"  id="date-text" type="text" value="<%=params[:textDate]%>" name="textDate" /></span></label>
			<input type="hidden" name="before" id="date-before" value="<%=params[:before]%>">
		    <input type="hidden" name="after" id="date-after"  value="<%=params[:after]%>">
			<label>на <span class="b-formfield b-popup_content_form_days_field"><input class="b-popup_content_form_days js-field_count" type="text" maxlength="2" name="nightsMin" value="<%=params[:nightsMin]%>" id="nightsMin" data-numbering-to="#fly-to-days" data-words='["день","дня","дней"]'/></span> <span id="fly-to-days">дней</span></label>
			<input type="hidden" name="nightsMax" value="<%=params[:nightsMax]%>" id="nightsMax">
			<label><span class="b-formfield"><input class="b-popup_content_form_adult js-field_count" type="text" maxlength="1" value="<%=params[:adult]%>" name="adult" data-numbering-to="#fly-to-adult" data-words='["взрослый","взрослых","взрослых"]'/></span> <span id="fly-to-adult">взрослых</span></label>
			<label><span class="b-formfield"><input class="b-popup_content_form_kid js-field_count" type="text" maxlength="1" value="<%=params[:child]%>" name="child" data-numbering-to="#fly-to-childs" data-words='["ребенок","ребенка","детей"]'/></span> <span id="fly-to-childs">детей</span></label>
			
			<%@default_params.each do |key,val|%>
	          <input type="hidden" name="<%=key%>" value="<%=val%>">
	        <%end%>
			<div class="b-search_form_set_buttons">
				<a onclick="$(this).closest('form').submit();return false;" href="#" class="b-search_form_set_submit g-gradient"><span>Найти туры</span><i></i><u></u></a>
				<a href="#" class="b-search_form_set_cancel">Отменить</a>
			</div>
		</form>
		
		<div class="b-search_form_direction">
			<div class="b-search_form_direction_item b-search_form_direction_item_flight">
				<%=@city%> — <%=@country%>, <%=params[:textDate]%>
				<i class="b-search_form_direction_item_icon"></i>
			</div>
			<div class="b-search_form_direction_item b-search_form_direction_item_days">
				<%=params[:nightsMin].to_i.word %w(день дня дней)%>
				<i class="b-search_form_direction_item_icon"></i>
			</div>
			<div class="b-search_form_direction_item b-search_form_direction_item_persons">
				<%=@count.word %w(турист туриста туристов)%>
				<i class="b-search_form_direction_item_icon"></i>
			</div>
			<div class="b-search_form_direction_edit">
				<a href="#" class="b-search_form_direction_edit_button">изменить</a>
			</div>
		</div>
		
		<div class="b-search_form_filters">
			<dl class="b-search_form_filters_item">
				<dt>Стоимость</dt>
				<dd>
					<span class="b-formfield b-search_form_filters_price b-search_form_filters_price_start"><input type="text" value="10000" name="price_start" id="filter-price-start"/></span>
					&mdash;
					<span class="b-formfield b-search_form_filters_price b-search_form_filters_price_end"><input type="text" value="<%=params[:adult].to_i+params[:child].to_i <= 2 ? '80000' : '100000'%>" name="price_end" id="filter-price-end"/></span>
					
					<div class="b-search_form_filters_price_range"></div>
				</dd>
				
			</dl>
			<dl class="b-search_form_filters_item">
				<dt>Звездность</dt>
				<dd class="b-search_form_filters_item_stars"> 
					<span class="b-search_form_filters_stars b-search_form_filters_stars_start" value="1" id="filter-stars-from"><i class="b-search_form_filters_stars_1"></i></span>
					&mdash;
					<span class="b-search_form_filters_stars b-search_form_filters_stars_end" value="5" id="filter-stars-to"><i class="b-search_form_filters_stars_5"></i></span>
				</dd>
			</dl>
			<dl class="b-search_form_filters_item">
				<dt>Тип питания</dt>
				<dd>
					<span class="b-formfield b-search_form_filters_food">
						<span class="b-formfield_select">
							<select id="filter-food">
								<option value="">Все возможные</option>
							</select>
							<span class="b-formfield_select_content"></span>
							<span class="b-formfield_select_icon"><i></i></span>
						</span>
					</span>
				</dd>
			</dl>
			<div class="clear"></div>
		</div>
	</div>
	<div class="b-search_result">
		<div class="b-search_result_header">
			<div class="b-search_result_col b-search_result_col1">Отель</div>
			<div class="b-search_result_col b-search_result_col2">Курорт</div>
			<div class="b-search_result_col b-search_result_col3">Дата заезда</div>
			<div class="b-search_result_col b-search_result_col4">Тип питания</div>
			<div class="b-search_result_col b-search_result_col5">Стоимость</div>
		</div>
		
		<div class="b-search_result_list" id="results">
		</div>
		
		<div class="b-search_result_item_form">
			<div class="b-search_result_item_form_top"><a></a><b></b><i></i><u></u><s></s></div>
			<form class="b-search_result_item_form_content b-card" id="reserve-form">
				<div class="b-card_header" id="form-tourists-data">Информация о туристах</div>
				<div class="b-card_header">Билеты на самолет</div>
				<div class="b-card_flight_data">
					<div class="b-card_flight_data_block b-card_flight_data_first">
						<span class="b-card_flight_data_caption">туда</span>
					</div>
					<div class="b-card_flight_data_block b-card_flight_data_second">
						<span class="b-card_flight_data_caption">обратно</span>
						
					</div>
				</div>
				<div class="b-card_summary">
					<a onclick="$(this).closest('form').submit();return false;" href="#" class="b-card_summary_submit g-gradient"><span>Забронировать тур</span><i></i><u></u></a>
					<div class="b-card_summary_notice">После отправки данных наш менеджер проверит актуальность предложения, забронирует тур и свяжется с вами. Оплатить вы сможете наличными у нас в офисе или курьеру.</div>
					<div class="b-card_summary_credit">Скоро можно будет оплатить кредитной картой<i class="b-card_summary_credit_icon"></i></div>
				</div>
			</form>
			<div class="b-search_result_item_form_bottom"><a></a><b></b><i></i><u></u><s></s></div>
		</div>
		
		<a href="#" class="b-search_result_more" id="more">Показать еще 10 туров</a>
	</div>
</div>

<script type="text/javascript">
var accommodations = <%=@accommodations.to_json.html_safe%>;
//Temlate for tour
var tourTemplate = function(tour) {
	//one tour is array. See http://xml.teztour.com/XML_JSON_TS.html
	var hotel = /(.*?)(\d[\+\s]*)\*$/.exec(tour[6]);
	if (hotel == null) {
		hotel = ['',tour[6],3]
	}
	hotel[2] = parseInt(hotel[2]);
	var date = tour[1].split('.');
	date = date[1]+'.'+date[0]+'.'+date[2];
	date = new Date(Date.parse(date)).format('d mmmmm yyyy')
	return '<div class="b-search_result_item" data-stars="'+hotel[2]+'" data-price="'+parseInt(tour[16])+'" data-food="'+tour[14]+'">'+
				'<div class="b-search_result_col b-search_result_col1 b-search_result_item_hotel">'+
					'<span class="b-search_result_item_hotel_stars"><i class="b-search_result_item_hotel_stars'+hotel[2]+'"></i></span>'+
					'<span class="b-search_result_item_hotel_name">'+hotel[1]+'</span>'+
				'</div>'+
				'<div class="b-search_result_col b-search_result_col2 b-search_result_item_resort">'+tour[10]+'</div>'+
				'<div class="b-search_result_col b-search_result_col3 b-search_result_item_date">'+date+'</div>'+
				'<div class="b-search_result_col b-search_result_col4 b-search_result_item_food">'+tour[14]+'</div>'+
				'<div class="b-search_result_col b-search_result_col5 b-search_result_item_price">'+tour[16]+'</div>'+
				'<div class="b-search_result_item_border"></div>'+
			'</div>';
};
$(function(){
	//parse query string and make params object
	var query = window.location.search.substring(1);
	var vars = query.split("&");
	var params = {};
	for (var i = 0; i < vars.length; i++) {
		var p =vars[i].split("=");
		params[p[0]] = p[1];
	}
	//select accomodation id
	$.each(accommodations,function(i,e){
		if (e.child == params.child && e.adult == params.adult) {
			params.accommodationId = e.accommodationId;
		}
	});

	var no_new_tours = false;
	var filter = (function(){
		var f = {
			price: [0,999999],
			stars: [0,5],
			food: ''
		};
		var visibleCount = 10;
		var applyTimeout = null;
		var updateMoreButton = function(more){
			if (more == 0) {
				$("#more").fadeOut();
			}
			else {
				$("#more").fadeIn();
				var newValue = Math.min(more,10) +' туров';
				if (more == 1) {
					newValue = '1 тур';
				}
				else if (more < 5) {
					newValue = more +' тура'
				}
				$("#more").text('Показать еще '+newValue);	
			}
		}
		var applyFilter = function(){
			var showed = 0;
			var more = 0;
			$(".b-search_result_item").each(function(){
				var accepted = true;
				for (var key in f) {
					var attr = $(this).attr('data-'+key);
					if (typeof f[key] == 'object') {
						if (attr < f[key][0] || attr > f[key][1]) accepted = false;
					}
					else {
						if (attr != f[key] && f[key] != '') accepted = false;
					}
				}
				if (!accepted) {
					$(this).animate({opacity: 0, height: 0},500,function(){$(this).hide();});
				}
				else if (showed >= visibleCount) {
					more++;
				}
				else {
					showed++;
					if ($(this).is(':hidden')) {
						$(this).css({opacity: 0, height: 0}).show().animate({opacity:1, height: '57px'},500,function(){
							$(this).css('height','auto');
						});
					}
				}
			});
			updateMoreButton(more);
			if ((more < 10 || $(".b-search_result_item:visible").length < 10) && !no_new_tours) {
				//fix speed when many elements loaded
				var newPrice = parseInt($(".b-search_result_item:last").attr('data-price'))+1;
				if (newPrice <= f.price[1]) loadTours(newPrice);
			}
		};
		var deferredApplyFilter = function(){
			visibleCount = 10;
			clearTimeout(applyTimeout);
			applyTimeout = setTimeout(applyFilter,200);
		};
		$("#filter-price-start").bind('change',function(){f.price[0] = parseInt($(this).val()); deferredApplyFilter();});
		$("#filter-price-end").bind('change',function(){f.price[1] = parseInt($(this).val()); deferredApplyFilter();});
		$("#filter-stars-from").bind('change',function(){f.stars[0] = $(this).attr('value'); applyFilter();});
		$("#filter-stars-to").bind('change',function(){f.stars[1] = $(this).attr('value'); applyFilter();});
		$("#filter-food").bind('change',function(){f.food = $(this).find('option:selected').val(); applyFilter();});
		return {
			next: function(){
				visibleCount += 10;
				applyFilter();
			},
			apply: function(){
				applyFilter();
			}
		}
	})();

	$("#more").click(function(){
		filter.next();
		return false;
	});

	$("#date-text").datepicker({dateFormat: 'mm.dd.yy'});
	$("#date-text").change(function(){
		var date = Date.parse($("#date-text").val());
		$("#date-text").val(new Date(date).format('d mmmmm'));
		$("#date-before").val(new Date(date+3*24*3600*1000).format('dd.mm.yyyy'));
		$("#date-after").val(new Date(date-3*24*3600*1000).format('dd.mm.yyyy'));
	});

	var loadTours = function(priceMin){
		params.priceMin = priceMin;
		$.ajax({
			dataType: 'jsonp',
			url: 'http://search.teztour.com/toursearch/getResult',
			type: 'get',
			data: params,
			success: function(data){
				if (!data.data || data.data.length == 0) {
					if (priceMin == 0) {
						no_new_tours = true;
						$("<div class='b-search_result_no_results'>Ничего не найдено. Попробуйте изменить запрос</div>").appendTo("#results");
					}
					return false;
				}	
				var foods = $("#filter-food").html();
				$.each(data.data,function(i, tour){
					if (foods.indexOf(tour[14]) == -1) foods += '<option value="'+tour[14]+'">'+tour[14]+'</option>';
					$(tourTemplate(tour)).appendTo("#results").data('tour',tour).hide();
				});
				$("#filter-food").html(foods).change();
				filter.apply();
			},
			error: function(){
				//api error
			}
		});	
	}
	loadTours(0);
	$("#more").hide();


	var formCreator = (function(){
		var form = $('.b-search_result_item_form');
		var touristTpl = function(i){
			return '<div class="b-card_personal_data">'+
					'<div class="b-card_personal_data_sex">'+
						'<span class="b-card_personal_data_caption">Пол</span>'+
						'<label class="b-card_personal_data_item b-card_personal_data_item_selected" title="Мужской">'+
							'<i class="b-card_personal_data_icon b-card_personal_data_icon_male"></i>'+
							'<input checked="checked" class="b-card_personal_data_field" type="radio" name="users['+i+'][sex]" value="male" />'+
							'<span class="b-card_personal_data_value">Мужской</span>'+
						'</label>'+
						'<label class="b-card_personal_data_item" title="Женский">'+
							'<i class="b-card_personal_data_icon b-card_personal_data_icon_female"></i>'+
							'<input class="b-card_personal_data_field" type="radio" name="users['+i+'][sex]" value="female" />'+
							'<span class="b-card_personal_data_value">Женский</span>'+
						'</label>'+
					'</div>'+
					'<div class="b-card_personal_data_name">'+
						'<label class="b-card_personal_data_caption">Имя и фамилия</label>'+
						'<label class="b-card_personal_data_notice">латинскими буквами</label>'+
						'<span class="b-formfield"><input class="b-card_personal_data_field" type="text" value="" name="users['+i+'][name]" /></span>'+
					'</div>'+
					'<div class="b-card_personal_data_passport">'+
						'<label class="b-card_personal_data_caption">Загранпаспорт</label>'+
						'<label class="b-card_personal_data_notice">серия и номер</label>'+
						'<span class="b-formfield"><input class="b-card_personal_data_field" type="text" value="" name="users['+i+'][passport]" /></span>'+
					'</div>'+
					'<div class="b-card_personal_data_phone">'+
						'<label class="b-card_personal_data_caption">Телефон</label>'+
						'<label class="b-card_personal_data_notice">+7 111 222 33 44</label>'+
						'<span class="b-formfield"><input class="b-card_personal_data_field" type="tel" value="" name="users['+i+'][phone]" /></span>'+
					'</div>'+
					'<div class="b-card_personal_data_email">'+
						'<label class="b-card_personal_data_caption">Электронная почта</label>'+
						'<label class="b-card_personal_data_notice">givemetotrip@rozovymarlin.ru</label>'+
						'<span class="b-formfield"><input class="b-card_personal_data_field" type="email" value="" name="users['+i+'][email]" /></span>'+
					'</div>'+
				'</div>';
		};
		var ticketsInfoTpl = function(data,name){
			var count = data['count'];
			if (count == 'Many' || count == 'Available') count = 'Много'
			else if (count == 'Few') count = 'Мало'
			else if (count == 'No') count = 'Нет'
			else count = word(count, ['билет','билета','билетов']);

			if (data['plus']) count += '<br />' + data['plus'];
			var klass = 'b-card_flight_data_item';
			if (data['count'] == 'No') klass+= ' b-card_flight_data_item_disabled';
			return '<label class="'+klass+'" title="'+data['title']+'">'+
				'<input class="b-card_flight_data_field" type="radio" name="flight['+name+']" value="'+data['title']+'" />'+
				'<span class="b-card_flight_data_icon"></span>'+
				'<span class="b-card_flight_data_value">'+data['title']+'</span>'+
				'<span class="b-card_flight_data_notice">'+count+'</span>'+
			'</label>';
		};
		var applyTouristsCount = function(count){
			$(".b-card_personal_data").remove();
			var html = '';
			for (var i=0;i<count;i++) {
				html += touristTpl(i);
			}
			$(html).insertAfter('#form-tourists-data');
			$('.b-formfield .b-card_personal_data_field').change(function () {
				if ($(this).val()) {
					$(this).parent().siblings('.b-card_personal_data_caption').hide();
				} else {
					$(this).parent().siblings('.b-card_personal_data_caption').show();
				}
			}).blur(function () {
				if (!$(this).val()) {
					$(this).parent().siblings('.b-card_personal_data_caption').show();
				}
			}).keyup(function () {
				if ($(this).val()) {
					$(this).parent().siblings('.b-card_personal_data_caption').hide();
				} else {
					$(this).parent().siblings('.b-card_personal_data_caption').show();
				}
			}).change();
		};
		var applyTicketsInfo = function(tour){
			$(".b-card_flight_data_item").remove();
			var tmp = [
				{title: 'Эконом', count: tour[19], plus: tour[23]},
				{title: 'Премиум', count: tour[20], plus: tour[24]},
				{title: 'Бизнес', count: tour[21], plus: tour[25]},
				{title: 'Первый', count: tour[22], plus: tour[26]}
			];
			for (var i in tmp) {
				$(ticketsInfoTpl(tmp[i],'first')).appendTo('.b-card_flight_data_first');
			}
			tmp = [
				{title: 'Эконом', count: tour[27], plus: tour[31]},
				{title: 'Премиум', count: tour[28], plus: tour[32]},
				{title: 'Бизнес', count: tour[29], plus: tour[33]},
				{title: 'Первый', count: tour[30], plus: tour[34]}
			];
			for (var i in tmp) {
				$(ticketsInfoTpl(tmp[i],'second')).appendTo('.b-card_flight_data_second');
			}
			$(".b-card_flight_data_first .b-card_flight_data_item:not(.b-card_flight_data_item_disabled):first").click();
			$(".b-card_flight_data_second .b-card_flight_data_item:not(.b-card_flight_data_item_disabled):first").click();
		};
		return {
			create: function(tour) {
				applyTouristsCount(parseInt(params.adult)+parseInt(params.child));
				applyTicketsInfo(tour)
				return form;
			}
		}
	})();

	//show and hide tour form
	$('.b-search_result_item .b-search_result_col').live('click',function () {
		var obj = $(this).parent('.b-search_result_item');
		var form = $('.b-search_result_item_form');

		var showForm = function(){
			formCreator.create(obj.data('tour')).slideDown(333, function () {
				$('body').stop().animate({scrollTop: $(obj).offset().top}, 1666, 'easeInOutExpo');
			});
		}
		
		if ($(obj).hasClass('b-search_result_item_selected')) {
			$(form).slideUp(333, function () {
				$(obj).removeClass('b-search_result_item_selected');
			});
		} else {
			if ($('.b-search_result_item_selected').length) {
				$(form).slideUp(333, function () {
					$('.b-search_result_item_selected').removeClass('b-search_result_item_selected');
					$(obj).append(form).addClass('b-search_result_item_selected');
					showForm();
				});
			} else {
				$(obj).append(form).addClass('b-search_result_item_selected');
				showForm();
				
			}
		}
	});

	$("#reserve-form").on('submit',function(){
		$.post('<%=reserve_path%>',$(this).serialize(),function(data){
			if (data.reserved) {
				$("<div class='b-search_result_no_results' id='thanks'>Спасибо! Наш менеджер свяжется с вами в ближайшее время.</div>").insertAfter('.b-search_result_item_form');
				$('.b-search_result_item_form').hide();
				setTimeout(function(){
					$("#thanks").animate({opacity: 0, height: 0},333,function(){
						$(this).remove();
						$(".b-search_result_item_selected").removeClass('b-search_result_item_selected');
					});
				},2000)
			}
		},'json');
		return false;
	});
});
</script>
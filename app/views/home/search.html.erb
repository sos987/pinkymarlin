<div class="b-search">
	<div class="b-search_form">
		<form class="b-search_form_set" action="">
			<span class="b-formfield b-popup_content_form_from">
				<span class="b-formfield_select">
					<select name="cityId">
					  <%City.all.each do |c|%>
		                <option value="<%=c.id%>" <%=c.id == params[:cityId].to_i ? 'selected="selected"'.html_safe : ''%>><%=c.name%></option>
		              <%end%>
					</select>
					<span class="b-formfield_select_content"></span>
					<span class="b-formfield_select_icon"><i></i></span>
				</span>
			</span>
			<i class="b-popup_content_form_direction"></i>
			<span class="b-formfield b-popup_content_form_to">
				<span class="b-formfield_select">
					<select name="countryId">
					  <%Country.all.each do |c|%>
		                <option value="<%=c.id%>" <%=c.id.to_i == params[:countryId].to_i ? 'selected="selected"' : ''%>><%=c.name%></option>
		              <%end%>
					</select>
					<span class="b-formfield_select_content"></span>
					<span class="b-formfield_select_icon"><i></i></span>
				</span>
			</span>
			
			<label>вылет <span class="b-formfield b-popup_content_form_date_field"><input class="b-popup_content_form_date js-field_count"  id="date-text" type="text" value="<%=params[:textDate]%>" name="textDate" /></span></label>
			<input type="hidden" name="before" id="date-before" value="<%=params[:before]%>">
		    <input type="hidden" name="after" id="date-after"  value="<%=params[:after]%>">
			<label>на <span class="b-formfield b-popup_content_form_days_field"><input class="b-popup_content_form_days js-field_count" type="text" maxlength="2" name="nightsMin" value="<%=params[:nightsMin]%>" id="nightsMin"/></span> дней</label>
			<input type="hidden" name="nightsMax" value="<%=params[:nightsMax]%>" id="nightsMax">
			<label><span class="b-formfield"><input class="b-popup_content_form_adult js-field_count" type="text" maxlength="1" value="<%=params[:adult]%>" name="adult" /></span> взрослых</label>
			<label><span class="b-formfield"><input class="b-popup_content_form_kid js-field_count" type="text" maxlength="1" value="<%=params[:child]%>" name="child" /></span> детей</label>
			
			<%@default_params.each do |key,val|%>
	          <input type="hidden" name="<%=key%>" value="<%=val%>">
	        <%end%>
			<div class="b-search_form_set_buttons">
				<a onclick="$(this).closest('form').submit();return false;" href="#" class="b-search_form_set_submit g-gradient"><span>Найти туры</span><i></i><u></u></a>
				<a href="#" class="b-search_form_set_cancel">Отменить</a>
			</div>
		</form>
		
		<div class="b-search_form_direction">
			<div class="b-search_form_direction_item b-search_form_direction_item_flight">
				<%=@city%> — <%=@country%>, <%=params[:textDate]%>
				<i class="b-search_form_direction_item_icon"></i>
			</div>
			<div class="b-search_form_direction_item b-search_form_direction_item_days">
				<%=params[:nightsMin].to_i.word %w(день дня дней)%>
				<i class="b-search_form_direction_item_icon"></i>
			</div>
			<div class="b-search_form_direction_item b-search_form_direction_item_persons">
				<%=@count.word %w(турист туриста туристов)%>
				<i class="b-search_form_direction_item_icon"></i>
			</div>
			<div class="b-search_form_direction_edit">
				<a href="#" class="b-search_form_direction_edit_button">изменить</a>
			</div>
		</div>
		
		<div class="b-search_form_filters">
			<dl class="b-search_form_filters_item">
				<dt>Стоимость</dt>
				<dd>
					<span class="b-formfield b-search_form_filters_price b-search_form_filters_price_start"><input type="text" value="30000" name="price_start" id="filter-price-start"/></span>
					&mdash;
					<span class="b-formfield b-search_form_filters_price b-search_form_filters_price_end"><input type="text" value="100000" name="price_end" id="filter-price-end"/></span>
					
					<div class="b-search_form_filters_price_range"></div>
				</dd>
				
			</dl>
			<dl class="b-search_form_filters_item">
				<dt>Звездность</dt>
				<dd class="b-search_form_filters_item_stars"> 
					<span class="b-search_form_filters_stars b-search_form_filters_stars_start" value="1" id="filter-stars-from"><i class="b-search_form_filters_stars_1"></i></span>
					&mdash;
					<span class="b-search_form_filters_stars b-search_form_filters_stars_end" value="5" id="filter-stars-from"><i class="b-search_form_filters_stars_5" id="filter-stars-to"></i></span>
				</dd>
			</dl>
			<dl class="b-search_form_filters_item">
				<dt>Тип питания</dt>
				<dd>
					<span class="b-formfield b-search_form_filters_food">
						<span class="b-formfield_select">
							<select id="filter-food">
							</select>
							<span class="b-formfield_select_content"></span>
							<span class="b-formfield_select_icon"><i></i></span>
						</span>
					</span>
				</dd>
			</dl>
			<div class="clear"></div>
		</div>
	</div>
	<div class="b-search_result">
		<div class="b-search_result_header">
			<div class="b-search_result_col b-search_result_col1">Отель</div>
			<div class="b-search_result_col b-search_result_col2">Курорт</div>
			<div class="b-search_result_col b-search_result_col3">Дата заезда</div>
			<div class="b-search_result_col b-search_result_col4">Тип питания</div>
			<div class="b-search_result_col b-search_result_col5">Стоимость</div>
		</div>
		
		<div class="b-search_result_list" id="results">
		</div>
		
		<div class="b-search_result_item_form">
			<div class="b-search_result_item_form_top"><a></a><b></b><i></i><u></u><s></s></div>
			<form class="b-search_result_item_form_content b-card">
				<div class="b-card_header">Информация о туристах</div>
				<div class="b-card_personal_data">
					<div class="b-card_personal_data_sex">
						<span class="b-card_personal_data_caption">Пол</span>
						<label class="b-card_personal_data_item b-card_personal_data_item_selected" title="Мужской">
							<i class="b-card_personal_data_icon b-card_personal_data_icon_male"></i>
							<input checked="checked" class="b-card_personal_data_field" type="radio" name="user[sex][]" value="male" />
							<span class="b-card_personal_data_value">Мужской</span>
						</label>
						<label class="b-card_personal_data_item" title="Женский">
							<i class="b-card_personal_data_icon b-card_personal_data_icon_female"></i>
							<input class="b-card_personal_data_field" type="radio" name="user[sex][]" value="female" />
							<span class="b-card_personal_data_value">Женский</span>
						</label>
					</div>
					<div class="b-card_personal_data_name">
						<label class="b-card_personal_data_caption">Имя и фамилия</label>
						<label class="b-card_personal_data_notice">латинскими буквами</label>
						<span class="b-formfield"><input class="b-card_personal_data_field" type="text" value="Konstantin Konstaninovich" name="user[name][]" /></span>
					</div>
					<div class="b-card_personal_data_passport">
						<label class="b-card_personal_data_caption">Загранпаспорт</label>
						<label class="b-card_personal_data_notice">серия и номер</label>
						<span class="b-formfield"><input class="b-card_personal_data_field" type="text" value="3333 666666" name="user[passport][]" /></span>
					</div>
					<div class="b-card_personal_data_phone">
						<label class="b-card_personal_data_caption">Телефон</label>
						<label class="b-card_personal_data_notice">+7 111 222 33 44</label>
						<span class="b-formfield"><input class="b-card_personal_data_field" type="tel" value="+7 917 016 88 33" name="user[phone][]" /></span>
					</div>
					<div class="b-card_personal_data_email">
						<label class="b-card_personal_data_caption">Электронная почта</label>
						<label class="b-card_personal_data_notice">givemetotrip@rozovymarlin.ru</label>
						<span class="b-formfield"><input class="b-card_personal_data_field" type="email" value="konstantinovich@yandex.ru" name="user[email][]" /></span>
					</div>
				</div>
				<div class="b-card_personal_data">
					<div class="b-card_personal_data_sex">
						<span class="b-card_personal_data_caption">Пол</span>
						<label class="b-card_personal_data_item" title="Мужской">
							<i class="b-card_personal_data_icon b-card_personal_data_icon_male"></i>
							<input class="b-card_personal_data_field" type="radio" name="user[sex][]" value="male" />
							<span class="b-card_personal_data_value">Мужской</span>
						</label>
						<label class="b-card_personal_data_item b-card_personal_data_item_selected" title="Женский">
							<i class="b-card_personal_data_icon b-card_personal_data_icon_female"></i>
							<input checked="checked" class="b-card_personal_data_field" type="radio" name="user[sex][]" value="female" />
							<span class="b-card_personal_data_value">Женский</span>
						</label>
					</div>
					<div class="b-card_personal_data_name">
						<label class="b-card_personal_data_caption">Имя и фамилия</label>
						<label class="b-card_personal_data_notice">латинскими буквами</label>
						<span class="b-formfield"><input class="b-card_personal_data_field" type="text" value="" name="user[name][]" /></span>
					</div>
					<div class="b-card_personal_data_passport">
						<label class="b-card_personal_data_caption">Загранпаспорт</label>
						<label class="b-card_personal_data_notice">серия и номер</label>
						<span class="b-formfield"><input class="b-card_personal_data_field" type="text" value="" name="user[passport][]" /></span>
					</div>
					<div class="b-card_personal_data_phone">
						<label class="b-card_personal_data_caption">Телефон</label>
						<label class="b-card_personal_data_notice">+7 111 222 33 44</label>
						<span class="b-formfield"><input class="b-card_personal_data_field" type="tel" value="" name="user[phone][]" /></span>
					</div>
					<div class="b-card_personal_data_email">
						<label class="b-card_personal_data_caption">Электронная почта</label>
						<label class="b-card_personal_data_notice">givemetotrip@rozovymarlin.ru</label>
						<span class="b-formfield"><input class="b-card_personal_data_field" type="email" value="" name="user[email][]" /></span>
					</div>
				</div>
				<div class="b-card_header">Билеты на самолет</div>
				<div class="b-card_flight_data">
					<div class="b-card_flight_data_block b-card_flight_data_first">
						<span class="b-card_flight_data_caption">туда</span>
						<label class="b-card_flight_data_item b-card_flight_data_item_selected" title="Эконом">
							<input checked="checked" class="b-card_flight_data_field" type="radio" name="flight[first][type]" value="economy" />
							<span class="b-card_flight_data_icon"></span>
							<span class="b-card_flight_data_value">эконом</span>
							<span class="b-card_flight_data_notice">много</span>
						</label>
						<label class="b-card_flight_data_item" title="Бизнес">
							<input class="b-card_flight_data_field" type="radio" name="flight[first][type]" value="business" />
							<span class="b-card_flight_data_icon"></span>
							<span class="b-card_flight_data_value">бизнес</span>
							<span class="b-card_flight_data_notice">8 билетов<br />+$300</span>
						</label>
						<label class="b-card_flight_data_item b-card_flight_data_item_disabled" title="Первый">
							<input disabled="disabled" class="b-card_flight_data_field" type="radio" name="flight[first][type]" value="first" />
							<span class="b-card_flight_data_icon"></span>
							<span class="b-card_flight_data_value">первый</span>
							<span class="b-card_flight_data_notice">нет</span>
						</label>
					</div>
					<div class="b-card_flight_data_block b-card_flight_data_second">
						<span class="b-card_flight_data_caption">обратно</span>
						<label class="b-card_flight_data_item b-card_flight_data_item_selected" title="Эконом">
							<input checked="checked" class="b-card_flight_data_field" type="radio" name="flight[first][type]" value="economy" />
							<span class="b-card_flight_data_icon"></span>
							<span class="b-card_flight_data_value">эконом</span>
							<span class="b-card_flight_data_notice">много</span>
						</label>
						<label class="b-card_flight_data_item" title="Бизнес">
							<input class="b-card_flight_data_field" type="radio" name="flight[first][type]" value="business" />
							<span class="b-card_flight_data_icon"></span>
							<span class="b-card_flight_data_value">бизнес</span>
							<span class="b-card_flight_data_notice">мало<br />+$300</span>
						</label>
						<label class="b-card_flight_data_item" title="Первый">
							<input class="b-card_flight_data_field" type="radio" name="flight[first][type]" value="first" />
							<span class="b-card_flight_data_icon"></span>
							<span class="b-card_flight_data_value">первый</span>
							<span class="b-card_flight_data_notice">много<br />+$800</span>
						</label>
					</div>
				</div>
				<div class="b-card_summary">
					<a onclick="$(this).closest('form').submit();return false;" href="#" class="b-card_summary_submit g-gradient"><span>Забронировать тур</span><i></i><u></u></a>
					<div class="b-card_summary_notice">После отправки данных наш менеджер проверит актуальность предложения, забронирует тур и свяжется с вами. Оплатить вы сможете наличными у нас в офисе или курьеру.</div>
					<div class="b-card_summary_credit">Скоро можно будет оплатить кредитной картой<i class="b-card_summary_credit_icon"></i></div>
				</div>
			</form>
			<div class="b-search_result_item_form_bottom"><a></a><b></b><i></i><u></u><s></s></div>
		</div>
		
		<a href="#" class="b-search_result_more" id="more">Показать еще 10 туров</a>
	</div>
</div>

<script type="text/javascript">
var accommodations = <%=@accommodations.to_json.html_safe%>;
//Temlate for tour
var tourTemplate = function(tour) {
	//one tour is array. See http://xml.teztour.com/XML_JSON_TS.html
	var hotel = /(.*?)\s(\d[^\s]*)\s\*$/.exec(tour[6]);
	if (hotel == null) {
		hotel = [tour[6],'']
	}
	var date = tour[1].split('.');
	date = date[1]+'.'+date[0]+'.'+date[2];
	date = new Date(Date.parse(date)).format('d mmmmm yyyy')
	return '<div class="b-search_result_item" data-stars="'+hotel[1]+'" data-price="'+tour[16]+'" data-food="'+tour[14]+'">'+
				'<div class="b-search_result_col b-search_result_col1 b-search_result_item_hotel">'+
					'<span class="b-search_result_item_hotel_stars"><i class="b-search_result_item_hotel_stars'+hotel[2]+'"></i></span>'+
					'<span class="b-search_result_item_hotel_name">'+hotel[1]+'</span>'+
				'</div>'+
				'<div class="b-search_result_col b-search_result_col2 b-search_result_item_resort">'+tour[10]+'</div>'+
				'<div class="b-search_result_col b-search_result_col3 b-search_result_item_date">'+date+'</div>'+
				'<div class="b-search_result_col b-search_result_col4 b-search_result_item_food">'+tour[14]+'</div>'+
				'<div class="b-search_result_col b-search_result_col5 b-search_result_item_price">от '+tour[16]+'</div>'+
				'<div class="b-search_result_item_border"></div>'+
			'</div>'
};
$(function(){
	//parse query string and make params object
	var query = window.location.search.substring(1);
	var vars = query.split("&");
	var params = {};
	for (var i = 0; i < vars.length; i++) {
		var p =vars[i].split("=");
		params[p[0]] = p[1];
	}
	//select accomodation id
	$.each(accommodations,function(i,e){
		if (e.child == params.child && e.adult == params.adult) {
			params.accommodationId = e.accommodationId;
		}
	});


	var filter = (function(){
		var f = {
			price: [0,999999],
			stars: [0,5],
			food: ''
		};
		var applyTimeout = null;
		var applyFilter = function(){
			clearTimeout(applyTimeout);
			applyTimeout = setTimeout(function(){
				$(".b-search_result_item:visible").each(function(){
					//скрыть видимые не подходящие под фильтр
					//при следующем клике "еще 10" выводить 10 подходящих
					//при изменении фильтра работать над множеством до последнего показанного
				});
			},100);
		};
		$("#filter-price-start").bind('change',function(){f.price[0] = parseInt($(this).val()); applyFilter();});
		$("#filter-price-end").bind('change',function(){f.price[1] = parseInt($(this).val()); applyFilter();});
		$("#filter-stars-from").bind('change',function(){f.stars[0] = $(this).attr('value'); applyFilter();});
		$("#filter-stars-to").bind('change',function(){
			console.log($(this).attr('value'));
			f.stars[1] = $(this).attr('value'); applyFilter();
		});
		$("#filter-food").bind('change',function(){f.food = $(this).find('option:selected').val(); applyFilter();});
		return {
			next: function(){

			},
		}
	})();

	$("#more").click(function(){
		$(".b-search_result_item:hidden:lt(10)").show();
		var more = $(".b-search_result_item:hidden").length;
		if (more == 0) {
			$(this).hide();
		}
		else {
			var newValue = Math.min(more,10) +' туров';
			if (more == 1) {
				newValue = '1 тур';
			}
			else if (more < 5) {
				newValue = more +' тура'
			}
			$(this).val('Показать еще '+newValue);	
		}
		return false;
	});

	$("#date-text").datepicker({dateFormat: 'mm.dd.yy'});
	$("#date-text").change(function(){
		var date = Date.parse($("#date-text").val());
		$("#date-text").val(new Date(date).format('d mmmmm'));
		$("#date-before").val(new Date(date+3*24*3600*1000).format('dd.mm.yyyy'));
		$("#date-after").val(new Date(date-3*24*3600*1000).format('dd.mm.yyyy'));
	});

	//make request to tez tour api and fetch tours
	$.ajax({
		dataType: 'jsonp',
		url: 'http://search.teztour.com/toursearch/getResult',
		type: 'get',
		data: params,
		success: function(data){
			if (data.data.count == 0) {
				//no tours found
				return false;
			}	
			var foods = '<option value="">Все возможные</option>';
			$.each(data.data,function(i, tour){
				if (foods.indexOf(tour[14]) == -1) foods += '<option value="'+tour[14]+'">'+tour[14]+'</option>';
				$(tourTemplate(tour)).appendTo("#results").hide();
			});
			$("#filter-food").html(foods).change();
			$("#more").click();
		}
	});
});
</script>